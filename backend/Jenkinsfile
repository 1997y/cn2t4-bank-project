pipeline {
    agent any

    environment {
        GITHUB_REPO = 'https://github.com/1997y/cn2t4-bank-project.git'
        TARGET_URL = "http://localhost:8000"  // OWASP ZAP 대상
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                npm install
                pip install bandit
                '''
            }
        }

        stage('ESLint') {
            steps {
                sh 'npx eslint . -f html -o eslint-report.html || true'
            }
        }

        stage('Bandit') {
            steps {
                sh 'bandit -r . -f html -o bandit-report.html || true'
            }
        }

        stage('OWASP ZAP') {
            steps {
                sh '''
                docker run -v $(pwd):/zap/wrk/:rw -t owasp/zap2docker-stable zap-baseline.py -t ${TARGET_URL} -r zap-report.html || true
                '''
            }
        }
    }

    post {
        always {
            publishHTML (target: [
                reportDir: '.', 
                reportFiles: 'eslint-report.html', 
                reportName: 'ESLint Report'
            ])
            publishHTML (target: [
                reportDir: '.', 
                reportFiles: 'bandit-report.html', 
                reportName: 'Bandit Report'
            ])
            publishHTML (target: [
                reportDir: '.', 
                reportFiles: 'zap-report.html', 
                reportName: 'OWASP ZAP Report'
            ])

            archiveArtifacts artifacts: '*.html', allowEmptyArchive: true
        }
    }
}
